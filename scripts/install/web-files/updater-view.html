<html>
<head>
<script  src='/jslib/jquery/jquery-2.2.1.min.js' type='text/javascript'></script>
<script src='/jslib/ansi_up/ansi_up.js' type='text/javascript'></script>
<link  href='/jslib/bootstrap/css/bootstrap-3-3-6.min.css' type='text/css' rel='stylesheet' />
<link  href='/jslib/flatui/css/flat-ui.css' type='text/css' rel='stylesheet' />
<style>
    div.navbar{
        border-bottom-right-radius: 0px;
        border-bottom-left-radius: 0px;
    }
</style>
<script>
        $( document ).ready(function() {
            var seeker = 0;
            var doneMessage = '';
            var url = "/logs/?" + new Date().getTime();
            var ansi_up = new AnsiUp;
            function send(){
                $.ajax({
                url: url,
                headers: {
                    'Range':'bytes=' + seeker + '-'
                },
                success: function(data, status, resp) {
                    range = resp.getResponseHeader('content-range');
                    seeker = parseInt(range.split('/')[1]);
                    if (data.search('Updating env done.') == -1 && data.search('Failed to update env.') == -1){
                        data = ansi_up.ansi_to_html(data);
                        $('#logs').append(data);
                        bottom();
                        setTimeout(send, 5000);
                    } else {
                        doneMessage = data;
                        finish();
                    }
                },
                error: function(resp, status, error) {
                    if (resp.status != 416 && resp.status != 404 && resp.status != 403 ) {
                        $('#logs').append('\n' + resp.status + error);
                    }
                    setTimeout(send, 5000);
                }
    
                });
            }
            send();
            function bottom() {
                var elem = document.getElementById('logs');
                elem.scrollTop = elem.scrollHeight;
            }
            function finish(){
                $.ajax({
                url: "/testdone",
                success: function(data, status, resp) {
                    setTimeout(finish, 2000);
                },
                error: function(resp, status, error) {
                    if (resp.status == 404 ) {
                        $('#logs').append(doneMessage);
                        bottom();
                        $("#redirect").toggleClass("hidden", false);
                        return;
                    }
                    setTimeout(finish, 2000);
                }
    
                });
            }
        });
</script>
</head>
<body>
        <div class="navbar navbar-inverse navbar-fixed-top"></div>
        <div class="container" style="padding-top:100px">
        <p class="breadcrumb">Update progress</p>
        <div><pre style="height:600px" id="logs"></pre></div>
        <button id="redirect"  onclick="location.href='/grid'" class="hidden btn" style="background-color:#345d78;color: #fff;">Back to portal</button>
        </div>
</body>
</html>